CREATE STREAM `DbHourlySummary` WITH ( KAFKA_TOPIC='db.public.HourlySummary', VALUE_FORMAT='AVRO' );

CREATE TABLE `RedisHourlySummary` WITH (
  kafka_topic='redis.HourlySummary',
  value_format='AVRO'
) AS
SELECT
  after->id AS id,
  AS_MAP(
    COLLECT_LIST(
      FORMAT_TIMESTAMP(
        PARSE_TIMESTAMP(after->hour, 'yyyy-MM-dd''T''HH:mm:ss.SSSSSS''Z'''),
        'HH'
      )
    ),
    COLLECT_LIST(after->hour_total)
  ) AS "data"
FROM `DbHourlySummary`
WINDOW TUMBLING (SIZE 1 DAY)
GROUP BY after->id
EMIT CHANGES;