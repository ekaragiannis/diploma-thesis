CREATE STREAM hourly_data 
WITH (
  KAFKA_TOPIC='timescaledb.public.hourly_data',
  VALUE_FORMAT='AVRO'
);

CREATE TABLE daily_device_summary WITH (
  kafka_topic='redis-daily-summary',
  value_format='AVRO'
) AS
SELECT
  CAST(after->device_id AS STRING) + ':' + FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'yyyy-MM-dd') AS "redis_key",
  AS_MAP(
    COLLECT_LIST(FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'HH')),
    COLLECT_LIST(ARRAY[after->avg_temp, after->max_temp, after->min_temp])
  ) AS "data"
FROM hourly_data
WINDOW TUMBLING (SIZE 24 HOURS, RETENTION 25 HOURS, GRACE PERIOD 1 HOUR)
GROUP BY CAST(after->device_id AS STRING) + ':' + FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'yyyy-MM-dd')
EMIT FINAL;

-- CREATE TABLE daily_device_summary WITH (
--   kafka_topic='redis-daily-summary',
--   value_format='AVRO'
-- ) AS
-- SELECT
--   CAST(after->device_id AS STRING) + ':' + FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'yyyy-MM-dd') AS "redis_key",
--   AS_MAP(
--     COLLECT_LIST(
--       FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'HH')
--     ),
--     COLLECT_LIST(ARRAY[after->avg_temp, after->max_temp, after->min_temp])
--   ) AS "data"
-- FROM hourly_data
-- WINDOW TUMBLING (SIZE 5 MINUTES, GRACE PERIOD 1 MINUTE)
-- GROUP BY CAST(after->device_id AS STRING) + ':' + FORMAT_TIMESTAMP(FROM_UNIXTIME(after->bucket / 1000), 'yyyy-MM-dd')
-- EMIT FINAL;
